sudo: required
services:
  - docker
language: go
go:
  - 1.16.x
install:
  - GO111MODULE=off go get -u github.com/vbatts/git-validation
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  - chmod +x kubectl
  - mv kubectl ${GOPATH}/bin
  - curl -Lo ./kind https://github.com/kubernetes-sigs/kind/releases/download/v0.9.0/kind-$(uname)-amd64
  - chmod +x ./kind
  - mv ./kind ${GOPATH}/bin
script:
  - git-validation -run DCO,short-subject || travis_terminate 1;
  - go fmt $(go list ./... | grep -v vendor) | grep -v "api.pb.go" | wc -l | grep "^0" || travis_terminate 1;
  - make docker-proto || travis_terminate 1;
  - git diff $(find . -name "*.pb.*go" -o -name "api.swagger.json" | grep -v vendor) | wc -l | grep "^0" || travis_terminate 1;
  - hack/check-api-version.sh || travis_terminate 1;
  - git grep -rw GPL vendor | grep LICENSE | egrep -v "yaml.v2" | wc -l | grep "^0" || travis_terminate 1;
  - bash hack/docker-integration-test.sh || travis_terminate 1;
  - bash hack/csi-sanity-test.sh || travis_terminate 1;
  - make install verify || travis_terminate 1;
  - if [ "${TRAVIS_PULL_REQUEST}" == "false" ]; then
      echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin; 
      make push-mock-sdk-server;
    fi
notifications:
  email:
    recipients:
      - cnbu-controlplane@purestorage.com
    on_success: change
    on_failure: always
